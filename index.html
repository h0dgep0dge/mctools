<!DOCTYPE html>
<html>
  <head>
    <style>
      img.itemimg {
        height: 64px;
        width: 64px;
        image-rendering: pixelated;
      }

      button.itembutton {
        padding: 4px;
        border-width: 2px;
        width: 76px;
        height: 76px;
        margin: 2px;
      }
    </style>
  </head>
  <body>
    <input type="file" id="selector">
    <div id='out'></div>
    <script src="pako/dist/pako.js"></script>
    <script src="node-nbt/dist/nbt.js"></script>
    <script src="buffer/dist/buffer.js"></script>
    <script>
      function arrayToString(arr) {
        var i, str = '';

        for (i = 0; i < arr.length; i++) {
          str += '%' + ('0' + arr[i].toString(16)).slice(-2);
        }
        return decodeURIComponent(str);
      }

      function nbt_find(list,name) {
        for(var i = 0;i < list.length;i++) {
          if(list[i].name == name) return list[i];
        }
      }

      function showInventory(items,table,editor) {
        while(table.firstChild) table.removeChild(table.firstChild);
        for(var row = 3;row >= 0;row--) {
          var rowDiv = document.createElement('div');
          for(var col = 0;col < items[row].length;col++) {
            var rowSpan = document.createElement('span');
            var button = document.createElement('button');
            button.setAttribute('class','itembutton');
            var img = document.createElement('img');
            img.setAttribute('src','items/blank.png');
            img.setAttribute('class','itemimg');
            if(items[row][col].id != '') {
              img.setAttribute('src','items/'+items[row][col].id.split(':')[1]+'.png');
            }
            button.addEventListener('click',function(col,row) {
              return function(e) {editItem(items[row][col],editor);};
            }(col,row));
            button.appendChild(img);
            rowSpan.appendChild(button);
            rowDiv.appendChild(rowSpan);
          }
          table.appendChild(rowDiv);
        }
      }

      function editItem(item,editor) {
        while(editor.firstChild) editor.removeChild(editor.firstChild);
        var inputs = {};
        for(var p in item) {
          var text = document.createTextNode(p + ' ');
          var input = document.createElement('input');
          input.setAttribute('type','text');
          input.setAttribute('value',item[p]);
          inputs[p] = input;
          var br = document.createElement('br');
          editor.appendChild(text);
          editor.appendChild(input);
          editor.appendChild(br);
        }
        var apply = document.createElement('input');
        apply.setAttribute('type','button');
        apply.setAttribute('value','Apply');
        apply.addEventListener('click',function(e) {
          for(var p in item) {
            item[p] = inputs[p].value;
          }
        });
        editor.appendChild(apply);
      }

      var e = document.getElementById('selector');
      var out = document.getElementById('out');
      e.addEventListener('change',function(e) {
        for(var i = 0;i < e.target.files.length;i++) {
          var f = e.target.files.item(i);
          var reader = new FileReader();
          reader.addEventListener('load',function(result) {
            var r = new Uint8Array(result.target.result);
            var d = pako.ungzip(r);
            var r = nbt.NbtReader.readTag(Buffer.Buffer(d));

            var v = r.val[0].val;
            var inventory = nbt_find(nbt_find(v,"Player").val,"Inventory").val;
            var items = [];

            for(var row = 0;row < 4;row++) {
              items[row] = [];
              for(var col = 0;col < 9;col++)
                items[row][col] = {id:'',damage:0,count:0};
            }

            for(var i = 0;i < inventory.list.length;i++) {
              var id = nbt_find(inventory.list[i].val,'id').val;
              var damage = nbt_find(inventory.list[i].val,'Damage').val;
              var count = nbt_find(inventory.list[i].val,'Count').val;
              var slot = nbt_find(inventory.list[i].val,'Slot').val;
              items[Math.floor(slot/9)][slot%9] = {id:id,damage:damage,count:count};
            }

            var table = document.createElement('div');
            var editor = document.createElement('div');
            var save = document.createElement('div');

            var saveButton = document.createElement('input');
            saveButton.setAttribute('type','button');
            saveButton.setAttribute('value','Save');
            saveButton.addEventListener('click',function(e) {console.log(items);});
            save.appendChild(saveButton);

            out.appendChild(table);
            out.appendChild(editor);
            out.appendChild(save);

            showInventory(items,table,editor);
            /*var o = nbt.NbtWriter.writeTag(r);
            var c = pako.gzip(o);
            var b = new Blob([c],{type: 'application/gzip'});

            var a = document.createElement('a');
            var linkText = document.createTextNode("Download");
            a.appendChild(linkText);
            a.href = URL.createObjectURL(b);
            document.body.appendChild(a);*/
          });
          reader.readAsArrayBuffer(f);
        }
      });
    </script>
  </body>
</html>
