<!DOCTYPE html>
<html>
  <head>
    <style>
      img.itembutton {
        height: 64px;
        width: 64px;
        image-rendering: pixelated;
      }
    </style>
  </head>
  <body>
    <input type="file" id="selector">
    <script src="pako/dist/pako.js"></script>
    <script src="node-nbt/dist/nbt.js"></script>
    <script src="buffer/dist/buffer.js"></script>
    <script>
      function arrayToString(arr) {
        var i, str = '';

        for (i = 0; i < arr.length; i++) {
          str += '%' + ('0' + arr[i].toString(16)).slice(-2);
        }
        return decodeURIComponent(str);
      }

      function nbt_find(list,name) {
        for(var i = 0;i < list.length;i++) {
          if(list[i].name == name) return list[i];
        }
      }

      var e = document.getElementById('selector');
      e.addEventListener('change',function(e) {
        for(var i = 0;i < e.target.files.length;i++) {
          var f = e.target.files.item(i);
          var reader = new FileReader();
          reader.addEventListener('load',function(result) {
            var r = new Uint8Array(result.target.result);
            var d = pako.ungzip(r);
            var r = nbt.NbtReader.readTag(Buffer.Buffer(d));

            var v = r.val[0].val;
            var inventory = nbt_find(nbt_find(v,"Player").val,"Inventory").val;
            var buttons = [];

            var table = document.createElement('table');
            for(var row = 3;row >= 0;row--) {
              buttons[row] = [];
              var tr = document.createElement('tr');
              for(var col = 0;col < 9;col++) {
                var td = document.createElement('td');
                var button = document.createElement('button');
                buttons[row][col] = button;
                var image = document.createElement('img');
                image.setAttribute('src','items/blank.png');
                image.setAttribute('class','itembutton');
                button.appendChild(image);
                td.appendChild(button);
                tr.appendChild(td);
              }
              table.appendChild(tr);
            }
            document.body.appendChild(table);
            for(var i = 0;i < inventory.list.length;i++) {
              var item = inventory.list[i].val;
              var id = nbt_find(item,'id').val;
              var slot = nbt_find(item,'Slot').val;

              var button = buttons[Math.floor(slot/9)][slot%9];
              while(button.firstChild) button.removeChild(button.firstChild);
              var image = document.createElement('img');
              image.setAttribute('src','items/'+id.split(':')[1]+'.png');
              image.setAttribute('class','itembutton');
              button.appendChild(image);
            }
            var o = nbt.NbtWriter.writeTag(r);
            var c = pako.gzip(o);
            var b = new Blob([c],{type: 'application/gzip'});

            var a = document.createElement('a');
            var linkText = document.createTextNode("Download");
            a.appendChild(linkText);
            a.href = URL.createObjectURL(b);
            document.body.appendChild(a);
          });
          reader.readAsArrayBuffer(f);
        }
      });
    </script>
  </body>
</html>
